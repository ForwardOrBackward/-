<html>
<head>
  <title>安装Tez</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/603932 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="7094"/>
<h1>安装Tez</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/10/28 20:22</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2021/4/8 11:50</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><span style="font-size: unset; color: unset; font-family: unset;">1、安装前提:</span></div><div>    For Tez version 0.9.0 and higher, Tez needs Apache Hadoop to be version 2.7.0 or higher.</div><div>       <img src="安装Tez_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>       </div><div>2、下载:</div><div>    <a href="http://www.apache.org/dyn/closer.lua/tez/0.9.2/">http://www.apache.org/dyn/closer.lua/tez/0.9.2/</a>   (官网下载)</div><div>    <a href="https://mirrors.tuna.tsinghua.edu.cn/apache/tez/0.9.2/">https://mirrors.tuna.tsinghua.edu.cn/apache/tez/0.9.2/</a>  (国内清华镜像站, 推荐)</div><div>    一般安装的话下载的是&quot;-bin&quot;文件,而不是下载&quot;-src&quot;文件, 因为&quot;-bin&quot;文件可以直接安装使用, 而&quot;-src&quot;文件需要先编译才能安装。</div><div>3、将压缩包上传(sftp)到Linux虚拟机:</div><div>    hive安装在哪个节点, 就把tez安装到哪个节点中去, 否则也不可能在当前节点给hive更换计算引擎了。我的hive安装在hadoop05, 所以把tez的安装包放到hadoop05。</div><div>    &gt; <span style="color: rgb(255, 0, 0);">put D:/Software/Tez/apache-tez-0.9.2-bin.tar.gz</span></div><div>4、解压:</div><div>    <span style="color: rgb(255, 0, 0);">tar -zxvf apache-tez-0.9.2-bin.tar.gz -C /home/hadoop/apps/</span></div><div>5、把解压前的hive压缩包放到hdfs的目录中去: (<span style="color: rgb(166, 0, 196);">注意这里上传的是tez的压缩包,而不是解压目录</span>)</div><div>    为什么要把tez放到hdfs中? 因为目前只在hive所在的节点安装tez, 但是执行任务时, 并不只是在hive所在的节点上执行, 而是会在集群中很多不同的datanode节点上执行(就像mapreduce程序将任务分发到各个节点执行,tez也一样), 为了保证集群中的各个节点都能使用到tez计算引擎(框架),就需要把tez的依赖包(即tez的压缩包)上传到hdfs之上, 供各个节点使用。</div><div><span style="color: rgb(255, 0, 0);">    hadoop fs -mkdir -p /apps/tez/</span></div><div><span style="color: rgb(255, 0, 0);">    hadoop fs -put apache-tez-0.9.2-bin.tar.gz /apps/tez/</span></div><div>6、修改配置文件</div><div>    (1)进入<span style="color: rgb(209, 0, 255);">hive</span>的安装目录的conf文件夹下, 并新建一个tez-site.xml的文件(<font style="color: rgb(166, 0, 196);">可能</font><span style="color: rgb(166, 0, 196);">tez-site.xml</span><font style="color: rgb(166, 0, 196);">不应该放在hive的安装目录下, 应该放在hadoop的安装目录下hadoop-2.7.4/etc/hadoop里, 毕竟mapred-site.xml也是放在hadoop安装目录下的</font>),用于配置一些Tez的参数:</div><div><span style="color: rgb(255, 0, 0);">        cd /home/hadoop/apps/apache-hive-2.3.6-bin/conf</span></div><div><span style="color: rgb(255, 0, 0);">        vim tez-site.xml</span></div><div>            在里面添加如下内容:</div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">&lt;configuration&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;!-- 这里指出hdfs上的tez.tar.gz包的位置,便于集群使用tez的jar包 --&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;name&gt;tez.lib.uris&lt;/name&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;value&gt;${fs.defaultFS}/apps/tez/apache-tez-0.9.2-bin.tar.gz&lt;/value&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;/property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;!-- 使用hadoop自身的lib包,设置为true的话可以使用minimal的tez包,false的话则使用tez-0.9.2.tar.gz的包 --&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;name&gt;tez.use.cluster.hadoop-libs&lt;/name&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;value&gt;true&lt;/value&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;/property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;description&gt;Enable Tez to use the Timeline Server for History Logging&lt;/description&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;name&gt;tez.history.logging.service.class&lt;/name&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;value&gt;org.apache.tez.dag.history.logging.ats.ATSHistoryLoggingService&lt;/value&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;/property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">&lt;/configuration&gt;</span><span style="color: rgb(255, 0, 0);"> </span>               </div><div>                    </div><div>    (2)依然在<span style="color: rgb(209, 0, 255);">hive</span>的安装目录的conf文件夹下,往hive-env.sh中添加一些内容(让hive能使用到tez的jar包):</div><div>        如果没有hive-env.sh文件, 则将hive-env.sh.template模板文件cp一份:</div><div>                        <span style="color: rgb(255, 0, 0);">cp hive-env.sh.template hive-env.sh </span></div><div><span style="color: rgb(255, 0, 0);">        vim hive-env.sh</span></div><div>            然后将hive-env.sh文件的内容末尾处变为如下内容:</div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);"># Set HADOOP_HOME to point to a specific hadoop install directory</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">HADOOP_HOME=/home/hadoop/apps/hadoop-2.7.4</span></div><div style="margin-left: 120px;"><br/></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);"># Hive Configuration Directory can be controlled by:</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">export HIVE_CONF_DIR=/home/hadoop/apps/apache-hive-2.3.6-bin/conf</span></div><div style="margin-left: 120px;"><br/></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);"># Folder containing extra libraries required for hive compilation/execution can be controlled by:</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">#export HIVE_AUX_JARS_PATH=</span></div><div style="margin-left: 120px;"><br/></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">#TEZ_HOME是tez的解压安装目录</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">export TEZ_HOME=/home/hadoop/apps/apache-tez-0.9.2-bin</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">export TEZ_JARS=&quot;&quot;</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">#通过两个for循环把所有tez需要的jar包都放到TEZ_JARS中</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">for jar in `ls $TEZ_HOME |grep jar`; do</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">    export TEZ_JARS=$TEZ_JARS:$TEZ_HOME/$jar</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">done</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">for jar in `ls $TEZ_HOME/lib`; do</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">    export TEZ_JARS=$TEZ_JARS:$TEZ_HOME/lib/$jar</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">done</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">#因为上面的循环导致TEZ_JARS的第一个字符是&quot;:&quot;,所以要去掉这个冒号</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">TEZ_JARS=${TEZ_JARS:1}</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">export HIVE_AUX_JARS_PATH=$TEZ_JARS            </span></div><div>      </div><div>      效果如下图(绿框中的内容如果以前安装hive时改过则不需要动, 如果没改过则也要修改):</div><div>      <img src="安装Tez_files/Image [1].png" type="image/png" data-filename="Image.png" width="808"/></div><div style="margin-left: 40px;">如果需要再加一些额外的jar包,如lzo压缩算法的包(前提是lzo的jar包如&quot;<span style="color: rgb(166, 0, 196);">hadoop-lzo-0.4.20.jars</span>&quot;已经提前放在&quot;<span style="color: rgb(166, 0, 196);">/home/hadoop/apps/hadoop-2.7.4/share/hadoop/common/lib</span>&quot;目录下了,则把上图中的最后一句代码改为:</div><div style="margin-left: 80px;">export HIVE_AUX_JARS_PATH=<span style="color: rgb(166, 0, 196);">$TEZ_JARS</span>:<span style="color: rgb(166, 0, 196);">/home/hadoop/apps/hadoop-2.7.4/share/hadoop/common/lib/hadoop-lzo-0.4.20.jars</span></div><div><br/></div><div>    (3))依然在<span style="color: rgb(209, 0, 255);">hive</span>的安装目录的conf文件夹下,修改hive-site.xml, 将hive的计算引擎修改为tez(不修改的话默认的计算引擎是mapreduce)。</div><div><span style="color: rgb(255, 0, 0);">        vim </span> <span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(255, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">hive-site.xml</span></div><div><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">            在&lt;configuration&gt; &lt;/configuration&gt;之间加入如下内容:</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">&lt;property&gt;</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">&lt;name&gt;hive.execution.engine&lt;/name&gt;</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">&lt;value&gt;tez&lt;/value&gt;</span></div><div style="margin-left: 120px;"><span style="color: rgb(255, 0, 0);">&lt;/property&gt;</span></div><div><br/></div><div>7、关闭虚拟内存检查。(关闭虚拟内存检查的原因见文末附录)</div><div><span style="color: rgb(255, 0, 0);">        cd /home/hadoop/apps/hadoop-2.7.4/etc/hadoop</span></div><div><span style="color: rgb(255, 0, 0);">        vim yarn-site.xml</span></div><div>            加入以下内容:</div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;property&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;name&gt;yarn.nodemanager.vmem-check-enabled&lt;/name&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">        &lt;value&gt;false&lt;/value&gt;</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">    &lt;/property&gt;</span></div><div>        修改完之后记得把yarn-site.xml文件分发到所有集群节点, 保持hadoop集群各节点的配置相同。</div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">scp /home/hadoop/apps/hadoop-2.7.4/etc/hadoop/yarn-site.xml hadoop@hadoop02:/home/hadoop/apps/hadoop-2.7.4/etc/hadoop/</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">scp /home/hadoop/apps/hadoop-2.7.4/etc/hadoop/yarn-site.xml hadoop@hadoop03:/home/hadoop/apps/hadoop-2.7.4/etc/hadoop/</span></div><div style="margin-left: 80px;"><span style="color: rgb(255, 0, 0);">......</span></div><div style="margin-left: 80px;"></div><div><br/></div><div style="margin-left: 40px;">分发完成后, 要<span style="color: rgb(255, 0, 0);">重启hadoop集群</span>, 在yarn-site.xml中新加入的配置才会生效。否则使用hive时还是会进行虚拟内存检查。</div><div><br/></div><div>8、测试</div><div>    启动hive:</div><div>        bin/hive</div><div>    在数据库中创建一张普通表(如student表):</div><div>        create table student(id int, name string, sex string, age string, major string);</div><div>    向表中插入一条数据:</div><div>        insert into student values(95031,'张三','男','20','CS');</div><div>        如果出现如下界面, 则说明hive使用的是tez计算引擎,说明tez安装成功:</div><div>        <img src="安装Tez_files/Image [2].png" type="image/png" data-filename="Image.png" width="738"/></div><div>    查看新插入的记录是否在表中:</div><div>        select * from student;</div><div><br/></div><div><br/></div><div><br/></div><div>附录:</div><div style="margin-left: 40px;"><span style="font-size: unset; color: unset; font-family: unset;">如果不关闭虚拟内存检查, 而你本身的内存不够的话,则会在使用hive时出现异常。(尤其是虚拟机,因为给虚拟机分配的内存通常很小,所以很容易出现这种状况)。错误原因可能会在启动hive时如下图红框所示:</span></div><div>    <img src="安装Tez_files/Image [3].png" type="image/png" data-filename="Image.png" width="773"/></div><div>       也可能会在使用hive运行sql语句时会报错:</div><div>        <img src="安装Tez_files/Image [4].png" type="image/png" data-filename="Image.png" width="755"/></div><div><br/></div><div>        如果成功安装Tez, 则运行(原先需要转换为mr程序的)sql语句时会出现一个进度条如下图:</div><div>        <img src="安装Tez_files/Image [5].png" type="image/png" data-filename="Image.png" width="732"/></div><div><br/></div></span>
</div></body></html> 