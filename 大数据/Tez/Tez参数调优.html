<html>
<head>
  <title>Tez参数调优</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/603932 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="7093"/>
<h1>Tez参数调优</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/11/11 14:39</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2020/12/22 21:22</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div>一、AM、Container大小设置 </div><div>1、hive.tez.container.size</div><div>默认值: -1</div><div>配置文件：hive-site.xml</div><div>参数说明：设置 tez container内存。默认情况下, Tez将生成一个mapper大小的容器。这可以用来覆盖默认值。</div><div>(Set hive.tez.container.size to be the same as or a small multiple(1 or 2 times that) of YARN container size yarn.scheduler.minimum-allocation-mb but NEVER more than yarn.scheduler.maximum-allocation-mb.)</div><div>建议: 不小于yarn.scheduler.minimum-allocation-mb值或者是其倍数。如果设置的太大会导致tez并发读过低，配置成yarn container大小即可    </div><div><br/></div><div>2、tez.am.resource.memory.mb   </div><div>默认值: 1024</div><div>配置文件：tez-site.xml</div><div>参数说明：设置 tez AM容器内存,  配置集群中每个Tez作业的<span style="font-size: 12.0pt; font-family: 宋体; mso-ascii-theme-font: minor-fareast; mso-fareast-theme-font: minor-fareast; mso-hansi-theme-font: minor-fareast; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-bidi-theme-font: minor-bidi; mso-font-kerning: 1.0pt; mso-ansi-language: EN-US; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">ApplicationMaster(DAGAppMaster)</span>所能占用的内存大小</div><div><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">(The amount of memory in MB to be used by the AppMaster. </span>Set tez.am.resource.memory.mb to be the same as yarn.scheduler.minimum-allocation-mb the YARN minimum container size.<span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">)</span></div><div>建议: 不小于等于yarn.scheduler.minimum-allocation-mb值。不能设置的太小，容易造成ApplicationMaster OOM，3倍的tez.container.size。</div><div><br/></div><div>二、AM、Container JVM参数设置</div><div>1、tez.am.launch.cmd-opts </div><div>默认值：-XX:+PrintGCDetails -verbose:gc -XX:+PrintGCTimeStamps -XX:+UseNUMA -XX:+UseParallelGC(用于GC)。默认的大小是：80%*tez.am.resource.memory.mb</div><div>配置文件：tez-site.xml</div><div>参数说明：设置 AM jvm，启动TEZ任务进程期间提供的命令行选项。一般不需要调整</div><div>建议: 不要在这些启动选项中设置任何xmx或xms，以便tez可以自动确定它们。</div><div> </div><div>2、hive.tez.java.opts</div><div>    默认值：Hortonworks建议“–server –<a href="http://djava.net.preferipv4stack%3dtrue/">Djava.net.preferIPv4Stack=true</a>–XX:NewRatio=8 –XX:+UseNUMA –XX:UseG1G”。默认大小：80%*hive.tez.container.size</div><div>    配置文件：hive-site.xml</div><div>    参数说明：设置 container jvm。配置Map任务的Java参数, 如果任务处理的数据量过大, 可以适当调节该参数, 避免OOM(内存溢出)。选择合理的垃圾回收器, 提升每个任务运行的吞吐量。</div><div> </div><div>3、tez.container.max.java.heap.fraction</div><div>    默认值：0.8</div><div>    配置文件：tez-site.xml</div><div>    参数说明：设置task/AM占用jvm Xmx内存大小的比例。这个值按具体需要调整，当内存不足时，一般都要调小。</div><div><br/></div><div><br/></div><div>三、Hive内存Map Join参数设置</div><div>1、tez.runtime.io.sort.mb</div><div>默认值：100</div><div>配置文件：tez-site.xml</div><div>参数说明：设置输出排序需要的内存大小。</div><div>建议: 设为 <span style="font-size: unset; color: unset; font-family: unset;">40%*hive.tez.container.size，一般不超过2G</span></div><div><br/></div><div>2、hive.auto.convert.join.noconditionaltask</div><div>默认值：true</div><div>配置文件：hive-site.xml</div><div>参数说明：设置是否将多个mapjoin合并为一个。</div><div>建议: 使用默认值。</div><div> </div><div>3、hive.auto.convert.join.noconditionaltask.size</div><div>默认值：10000000    (10M<span style="font-size: unset; color: unset; font-family: unset;">)</span></div><div>配置文件：hive-site.xml</div><div>参数说明：这个参数使用的前提是hive.auto.convert.join.noconditionaltask值为true。多个mapjoin转换为1个时，所有小表的文件大小总和要小于这个值，这个值只是限制输入的表文件的大小，并不代表实际mapjoin时hashtable的大小。 </div><div>建议值：1/3* hive.tez.container.size</div><div> </div><div>4、tez.runtime.unordered.output.buffer.size-mb</div><div>默认值：100</div><div>配置文件：tez-site.xml</div><div>参数说明： 如果不直接写入磁盘，要使用的缓冲区的大小。</div><div>建议值：10%* hive.tez.container.size</div><div><br/></div><div><br/></div><div>四、Container重用设置</div><div>1、tez.am.container.reuse.enabled</div><div>    默认值：true</div><div>    配置文件：tez-site.xml</div><div>    参数说明：Container重用开关</div><div><br/></div><div><br/></div><div>Hive中Tez和LLAP相关的配置。</div><div>Tez和MapReduce这两种计算引擎从架构到编写具体的项目代码其实有很多共通的地方, 因此在配置Tez的环境参数方面也基本差不多。下面是Tez常用的配置。</div><div>tez.am.resource.memory.mb: 配置集群中每个Tez作业的ApplicationMaster(DAGAppMaster)所能占用的内存大小。</div><div>tez.grouping.max-size、tez.grouping.min-size: 配置集群中每个Map任务分组分片最大数据量和最小数据量。</div><div>hive.tez.java.opts: 配置Map任务的Java参数, 如果任务处理的数据量过大, 可以适当调节该参数, 避免OOM(内存溢出)。选择合理的垃圾回收器, 提升每个任务运行的吞吐量。</div><div>hive.convert.join.bucket.mapjoin.tez: 配置是否开启转换成桶MapJoin的表连接。默认是false, 表示不开启。</div><div>hive.merge.tezifiles: 是否合并Tez任务最终产生的小文件。</div><div>hive.tez.cpu.vcores: 配置每个容器运行所需的虚拟CPU个数。</div><div>hive.tez.auto.reducer.parallelism: 配置是否开启作业自动调节在Reduce阶段的任务并行度。</div><div>hive.tez.bigtable.minsize.semijoin.reduction: 设置当大表的行数达到该配置指定的行数时可以启动半连接。</div><div>hive.tez.dynamic.semijoin.reduction: 设置动态启用半连接操作进行过滤数据。</div><div>hive.llap.execution.mode: 配置Hive使用LLAP的模式,共有以下5种模式:</div><div style="margin-left: 40px;">none: 所有的操作都不使用LLAP。</div><div style="margin-left: 40px;">map: 只允许Map阶段的操作使用LLAP。</div><div style="margin-left: 40px;">all: 所有的操作都尽可能尝试使用LLAP, 如果执行失败则使用容器的方式运行。</div><div style="margin-left: 40px;">only: 所有的操作都尽可能尝试LLAP, 如果执行失败, 则查询失败。</div><div style="margin-left: 40px;">auto: 由Hive控制LLAP模式。</div><div>hive.llap.object.cache.enabled: 是否开启LLAP的缓存, 缓存可以缓存执行计划、散列表。</div><div>hive.llap.io.use.lrfu: 指定缓存的策略为LRFU模式, 替换掉默认的FIFO模式。</div><div>hive.llap.io.enabled: 是否启用LLAP的数据I/O。</div><div>hive.llap.io.cache.orc.size: LLAP缓存数据的大小, 默认是1GB。</div><div>hive.llap.io.threadpool.size: LLAP在进行I/O操作的线程池大小,默认为10。</div><div>hive.llap.io.memory.mode: LLAP内存缓存的模式, 共有以下3种模式:</div><div style="margin-left: 40px;">cache: 将数据和数据的元数据放到自定义的堆外缓存中。</div><div style="margin-left: 40px;">allocator: 不使用缓存, 使用自定义的allocator。</div><div style="margin-left: 40px;">none: 不使用缓存。(上面两种模式使用不当的话可能导致性能急剧下降)</div><div>hive.llap.io.memory.size: LLAP缓存数据的最大值。</div><div>hive.llap.auto.enforce.vectorized: 是否强制使用向量化的运行方式, 默认为true。</div><div>hive.llap.auto.max.input.size、hive.llap.auto.min.input.size: 是否检查输入数据的文件大小, 如果为-1则表示不检查。hive.llap.auto.max.input.size默认值为10GB, hive.llap.min.input.size默认值为1GB。</div><div><br/></div><div><br/></div></span>
</div></body></html> 