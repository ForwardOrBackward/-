<html>
<head>
  <title>Hive源码编译及阅读修改调试</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/603932 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="7711"/>
<h1>Hive源码编译及阅读修改调试</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2021/1/19 15:24</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2021/1/22 19:11</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><br/></div><div style="font-size: 16px; min-width: 100%; position: relative;"><div style="font-size: 10px; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); -webkit-font-smoothing: antialiased; box-sizing: border-box; background: rgb(255, 255, 255); text-size-adjust: 100%;"><div style="box-sizing: border-box; min-width: 100%; background-color: rgb(248, 248, 248); font-size: 12px; -webkit-font-smoothing: antialiased;"><div style="box-sizing:border-box;overflow:hidden;"><div style="box-sizing:border-box;background-color:rgb(255, 255, 255);"><h2 style="box-sizing: border-box; padding: 0px; margin: 0px; overflow-wrap: break-word; font-size: 32px;"><span style="font-size: 32px; font-style: normal; font-weight: 700;" title="点击以取消高亮显示">Hive源码编</span><span style="font-size: 32px; font-style: normal; font-weight: 700;">译</span><span style="font-size: 32px; font-style: normal; font-weight: 700;" title="点击以取消高亮显示">及阅</span><span style="font-size: 32px; font-style: normal; font-weight: 700;" title="点击以取消高亮显示">读修</span><span style="font-size: 32px; font-style: normal; font-weight: 700;" title="点击以取消高亮显示">改调试</span></h2><div style="box-sizing: border-box; margin: 0px; padding: 0px; font-size: 12px;"><div style="box-sizing:border-box;margin:0px;padding:0px;float:right;"></div></div><div style="box-sizing:border-box;margin:0px;padding:0px;position:relative;"><div style="box-sizing: border-box; margin: 0px; padding: 0px; overflow-wrap: break-word; font-size: 16px; overflow: hidden; word-break: break-all;"><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: center; background-color: rgb(255, 255, 255);"><a href="https://yq.aliyun.com/go/articleRenderRedirect?url=http%3A%2F%2Fs2.51cto.com%2Fwyfs02%2FM01%2F8F%2F3E%2FwKioL1jYvqTgYwwyAAFtOvcalJ0898.jpg-wh_651x-s_2035028216.jpg" style="background-color: transparent; box-sizing: border-box; transition: color 0.2s ease 0s; font-size: 16px; color: rgb(255, 66, 0); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px; text-decoration: none;" target="_blank"><img src="Hive源码编译及阅读修改调试_files/wKioL1jYvqTgYwwyAAFtOvcalJ0898.jpg-wh_651x-s_2035028216.jpg" type="image/jpeg" data-filename="wKioL1jYvqTgYwwyAAFtOvcalJ0898.jpg-wh_651x-s_2035028216.jpg" height="0" style="border:none;vertical-align:middle;box-sizing:border-box;max-width:100%;height:auto;" width="0"/></a></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">下载编译</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">在git上下载合适的master分支，使用maven编译。执行编译的目的在于，确保过程中生成的代码(Thrift)已经生成，这样导入IDEA就不会出现有些类找不到的情况。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">执行源码编译分发命令，进入源码根目录执行：</span></div><div style="overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857; color: rgb(51, 51, 51); word-break: break-all; overflow-wrap: break-word; background-color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-radius: 4px; font-size: 13px; box-sizing: border-box; padding: 9.5px; margin: 0px 0px 10px;"></div><div style="box-sizing: border-box; margin: 0px; padding: 0px 3px 0px 10px; list-style-type: decimal; border: none; background: url(&quot;http://images.51cto.com/images/art1105/images/0.gif&quot;) -498px -70px repeat-y scroll transparent; list-style-position: outside;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">mvn clean package -Phadoop-2 -DskipTests -Pdist </span></span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">这里必须指定profile为hadoop-2来支持hadoop 2.x版本</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">1、后续更改完源码后，还需执行该命令来编译打包。源码更改后需评价其对Hive各模块的影响(改动代码多的话可通过pom的依赖来看)，如果影响的模块非常少，可以直接进入相应的模块进行上述命令的编译打包，如果影响模块很多，则直接在Hive源码根目录进行编译打包。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">2、打完包后，将受影响的包进行线上替换，重启受影响的组件即可应用上改后的代码。如果在CDH环境，要注意所有YARN的节点都需进行包的替换，因为Hive的MR任务启动后，节点上Container的启动其核心包是加载的本地jar包，而不是HDFS上的jar包。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">导入IDEA进行源码阅读修改</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">在Intellij里打开编译后的工程，它是一个Maven工程，软件会自动区分模块并导入。导入后可以看到源码，但我们会发现，很多关于hadoop的地方标红了，表示不可用，这是为什么呢?</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">这是因为版本依赖的原因，hive可编译为依赖 hadoop1 或 hadoop2，在编译源码的时候就已提示过让我们输入支持哪个，否则不能编译!</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">这里也一样，需要我们选择其依赖，才能正确的导入maven依赖包!</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">在Intellij的右侧，有个maven project的停靠栏，点击它可以看到有个 profiles的子项，我们可以明显看到hadoop-2是没有勾选的，这里勾选上它，它所指定的相应依赖就会被导入，源码就不会标红啦!就可以放心的改源码啦!</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">如下图</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: center; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; color: rgb(255, 66, 0); font-family: &quot;Microsoft Yahei&quot;;"><img src="Hive源码编译及阅读修改调试_files/Image.png" type="image/png" data-filename="Image.png"/></span><a href="https://yq.aliyun.com/go/articleRenderRedirect?url=http%3A%2F%2Fs5.51cto.com%2Fwyfs02%2FM02%2F8F%2F40%2FwKiom1jYvsjz0rw_AAD3eWHsszw153.jpg" style="background-color: transparent; box-sizing: border-box; transition: color 0.2s ease 0s; font-size: 16px; color: rgb(255, 66, 0); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px; text-decoration: none;" target="_blank"><img src="Hive源码编译及阅读修改调试_files/wKiom1jYvsjz0rw_AAD3eWHsszw153.jpg" type="image/jpeg" data-filename="wKiom1jYvsjz0rw_AAD3eWHsszw153.jpg" height="0" style="border:none;vertical-align:middle;box-sizing:border-box;max-width:100%;height:auto;" width="0"/></a></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">开启调试之旅</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">调试前提</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">调试代码时最好不执行完全分布式任务(会分配到多台节点机执行的MR任务)，代码跑动控制在当前JVM范围内(可以是多线程的)，否则代码跟踪超级麻烦。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">如果需要执行MR任务，最好以local模式执行，打开命令SET mapreduce.framework.name=local;</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">有些任务也不需要起MR，这样更方便调试，尽可能不起MR：set hive.exec.mode.local.auto = true;，并调大hive.exec.mode.local.auto.tasks.max(默认4)和hive.exec.mode.local.auto.inputbytes.max(默认128M)，当且仅当自动开启本地模式设为true，并且输入的文件数量和数据量大小分别都小于这两个值的时候，才不会起MR任务。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">1、Hive起完全分布式的MR任务也可追踪，但是需要修改节点机上的MR启动时Java参数，而且Hive起一个MR任务时，只有当MR启动后才能知道哪个节点机上启动了该任务，之后才能进行Remote debug连接，这在运行环境为完全分布式时会比较麻烦。但如果运行环境为伪分布式，那么追踪可能会更方便些。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">2、Hive调试，实际运行环境为伪分布式集群环境或完全分布式集群环境都可以。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">Hive调试需保证调试代码和运行环境的代码一致，否则调试会出现断点位置对不上的问题，影响我们调试。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">如果是在Kerberos环境，运行Hive命令的用户需具备Kerberos认证，因为调试跟正常执行任务其实没什么区别。调试端(如Windows上的IDEA)不需要认证，它只要能连通开启的JVM端口即可。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">调试原理</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">基于Sun Microsystem 的 Java Platform Debugger Architecture (JPDA) 技术，它由两个接口(分别是 JVM Tool Interface 和 JDI)、一个协议(Java Debug Wire Protocol)和两个用于合并它们的软件组件(后端和前端)组成，可以远程调试任何基于JVM的程序。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">要启用调试，只需在软件的JVM启动时加载以下参数：</span></div><div style="overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857; color: rgb(51, 51, 51); word-break: break-all; overflow-wrap: break-word; background-color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-radius: 4px; font-size: 13px; box-sizing: border-box; padding: 9.5px; margin: 0px 0px 10px;"></div><div style="box-sizing: border-box; margin: 0px; padding: 0px 3px 0px 10px; list-style-type: decimal; border: none; background: url(&quot;http://images.51cto.com/images/art1105/images/0.gif&quot;) -498px -70px repeat-y scroll transparent; list-style-position: outside;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">-Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n </span></span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">或</span></div><div style="overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857; color: rgb(51, 51, 51); word-break: break-all; overflow-wrap: break-word; background-color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-radius: 4px; font-size: 13px; box-sizing: border-box; padding: 9.5px; margin: 0px 0px 10px;"></div><div style="box-sizing: border-box; margin: 0px; padding: 0px 3px 0px 10px; list-style-type: decimal; border: none; background: url(&quot;http://images.51cto.com/images/art1105/images/0.gif&quot;) -498px -70px repeat-y scroll transparent; list-style-position: outside;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 </span></span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">参数含义：</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: center; background-color: rgb(255, 255, 255);"><a href="https://yq.aliyun.com/go/articleRenderRedirect?url=http%3A%2F%2Fs4.51cto.com%2Fwyfs02%2FM00%2F8F%2F40%2FwKiom1jYvtmxCCOXAABrLMtQnSo366.jpg" style="background-color: transparent; box-sizing: border-box; transition: color 0.2s ease 0s; font-size: 16px; color: rgb(255, 66, 0); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px; text-decoration: none;" target="_blank"><img src="Hive源码编译及阅读修改调试_files/wKiom1jYvtmxCCOXAABrLMtQnSo366.jpg" type="image/jpeg" data-filename="wKiom1jYvtmxCCOXAABrLMtQnSo366.jpg" height="0" style="border:none;vertical-align:middle;box-sizing:border-box;max-width:100%;height:auto;" width="0"/></a></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">Hive Cli 调试</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">在运行环境开启Hive Cli命令行，执行： bin/hive --debug -hiveconf hive.root.logger=DEBUG,console，此时界面会显示 Listening for transport dt_socket at address: 8000，表明远程调试模式已开。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">然后在IntelliJ里配置远程调试模式，Run -&gt; Debug -&gt; Edit Configurations，然后点左上角 + 号按钮，选择 Remote，配好Host为运行Hive Cli命令的主机，Port为8000，然后起个方便识别的名字，点击Debug就可以开始调试源码了。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">一旦这边远程连接上了集群环境的调试端口，集群那边就会打日志并出现hive &gt;这样的输入光标，在IDEA里打断点，然后在Hive Cli里执行HQL语句，我们就可以看到IDEA这边的断点信息，然后逐步调试。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">HiveServer2 调试</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">以下以CDH集群环境做说明，路径与你安装的CDH路径有关，Apache开源环境找到对应配置文件即可。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">修改hiveserver2所在机器的/opt/cloudera/parcels/CDH/lib/hive/bin/hive-config.sh文件，在最后加上</span></div><div style="overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857; color: rgb(51, 51, 51); word-break: break-all; overflow-wrap: break-word; background-color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-radius: 4px; font-size: 13px; box-sizing: border-box; padding: 9.5px; margin: 0px 0px 10px;"></div><div style="box-sizing: border-box; margin: 0px; padding: 0px 3px 0px 10px; list-style-type: decimal; border: none; background: url(&quot;http://images.51cto.com/images/art1105/images/0.gif&quot;) -498px -70px repeat-y scroll transparent; list-style-position: outside;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">export HADOOP_OPTS=</span><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 255); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">&quot;$HADOOP_OPTS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005&quot;</span><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;"> </span></span></div><div style="box-sizing: border-box; margin: 0px; padding: 0px 3px 0px 10px; list-style-type: decimal; border: none; background: url(&quot;http://images.51cto.com/images/art1105/images/0.gif&quot;) -498px -70px repeat-y scroll transparent; list-style-position: outside;"><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">export HADOOP_VERSION=<span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 255); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;">&quot;2.6.0-cdh5.5.1&quot;</span><span style="box-sizing: border-box; margin: 0px; padding: 0px; border: none; background-color: inherit; font-size: 14px; color: rgb(0, 0, 0); font-family: Arial; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px;"> </span></span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">其中HADOOP_VERSION由命令hadoop version可得到。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">改完配置后在CM里重启Hiveserver2，这时在HiveServer2所在机器上查看5005端口，会发现处于监听状态，然后利用Intellij如上面的debug一样，即可连接上远程的hiveserver2。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">打好断点，之后在某一节点上启动beeline，连接上该hiveserver2，执行hql，这边就可以源码追踪。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">1、注意端口别占用了，否则会报: JDWP No transports initialized, jvmtiError=AGENT_ERROR_TRANSPORT_INIT</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">2、如果整个Hive需要重启，需把上面更改注释掉，待Hive重启完毕后，再把注释改回来然后单独重启HiveServer2。这是因为Hive MetaStore启动时也会用到该脚本，而MetaStore先启动，会进入MetaStore的调试。之后启动HiveServer2时就会出现端口占用的情况</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; box-sizing: border-box; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">Beeline 调试</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">以下以CDH集群环境做说明，自己的安装环境寻找相应配置即可</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">修改需要运行beeline的机器上的beeline脚本的执行脚本，我的位置为：/opt/cloudera/parcels/CDH/lib/hive/bin/ext/beeline.sh，在脚本最后的export HADOOP_CLIENT_OPTS后加上 -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005。</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">如下：</span></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: center; background-color: rgb(255, 255, 255);"><a href="https://yq.aliyun.com/go/articleRenderRedirect?url=http%3A%2F%2Fs1.51cto.com%2Fwyfs02%2FM00%2F8F%2F40%2FwKiom1jYvuehYUxZAABWs2pnTB4570.jpg" style="background-color: transparent; box-sizing: border-box; transition: color 0.2s ease 0s; font-size: 16px; color: rgb(255, 66, 0); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px; text-decoration: none;" target="_blank"><img height="0" src="https://s1.51cto.com/wyfs02/M00/8F/40/wKiom1jYvuehYUxZAABWs2pnTB4570.jpg" style="border:none;vertical-align:middle;box-sizing:border-box;max-width:100%;height:auto;" width="0"></img></a></div><div style="box-sizing: border-box; margin: 0px 0px 16px; padding: 0px 0px 15px; font-size: 16px; text-align: justify; background-color: rgb(255, 255, 255);"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: &quot;Microsoft Yahei&quot;; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 30px;">改完后，在该机器上执行beeline即可进入监听状态，IDEA进行远程连接即可</span></div></div></div></div></div></div></div></div><div><br/></div></span>
</div></body></html> 