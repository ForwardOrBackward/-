<html>
<head>
  <title>hive中分区和分桶补充笔记</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/603932 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="6353"/>
<h1>hive中分区和分桶补充笔记</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/8/20 15:03</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2020/8/20 15:04</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div>create database if not exists myhive1;</div><div>use myhive1;</div><div>drop table if exists student;</div><div>create table student(id int, name string, sex string ,age int, department string) row format delimited fields terminated by &quot;,&quot;;</div><div>load data local inpath &quot;/home/hadoop/student.txt&quot; into table student;</div><div>select * from student;</div><div><br/></div><div>一、分区</div><div>     hive表就是hdfs的上的一个目录</div><div>     hive表中的数据，其实就是对应了HDFS上的一个目录下的数据</div><div>     概念：对hive表的数据做分区管理</div><div><br/></div><div>     创建分区表</div><div>     create table student_ptn(id int, name string) partitioned by (age int, department string) row format delimited fields terminated by &quot;,&quot;;</div><div>    </div><div>     添加分区</div><div>     // 添加一个分区</div><div>     alter table student_ptn add partition(age=44,department=&quot;AA&quot;);</div><div>     // 一次添加多个分区</div><div>     alter table student_ptn add partition(age=66,department=&quot;CC&quot;) partition(age=55,department=&quot;BB&quot;);</div><div>     // 添加成功。但是分区字段的顺序是在创建分区表的时候决定的</div><div>     alter table student_ptn add partition(department=&quot;DD&quot;,age=77);</div><div>     // 添加分区时，指定分区的数据存储目录</div><div>     alter table student_ptn add partition(age=88,department=&quot;EE&quot;) location &quot;/ptn_input1&quot; partition(age=99,department=&quot;FF&quot;) location &quot;/ptn_input2&quot;;</div><div><br/></div><div>     查询分区</div><div>     show partitions student_ptn;</div><div><br/></div><div>     修改分区</div><div>     alter table student_ptn partition(age=44,department=&quot;AA&quot;) set location &quot;<a href="hdfs://hadoop02:9000/ptn_input3">hdfs://hadoop02:9000/ptn_input3&quot;;</a></div><div><br/></div><div>     // 往某个特定的分区导入数据</div><div>     load data local inpath &quot;/home/hadoop/student.txt&quot; into table student_ptn partition(age=55,department=&quot;BB&quot;);</div><div><br/></div><div>     load data local inpath &quot;/home/hadoop/student.txt&quot; into table student_ptn;  XXXXX  不能直接往分区表导入数据</div><div><br/></div><div>     // 删除分区</div><div>     alter table student_ptn drop partition(age=44,department=&quot;AA&quot;); </div><div>     // 删除分区的时候，包括分区的元数据信息和分区的数据及目录</div><div>     // 清空分区表的时候，分区还在，数据被清空</div><div><br/></div><div>     导入数据，大体上说，总共有三种方式：</div><div>     1、hadoop fs</div><div>     2、load</div><div>     3、insert ....select....</div><div><br/></div><div>     // 使用insert....values... 的方法是导入数据，主要用于测试</div><div>     insert into table student_ptn values (101,&quot;liutao&quot;);</div><div>     insert into table student_ptn partition(age=66,department=&quot;CC&quot;) values (101,&quot;liutao&quot;);</div><div><br/></div><div>     // 使用单重或者多重模式进去插入</div><div>     from student</div><div>     insert ... select ....</div><div>     insert ... select ....</div><div><br/></div><div>     from student</div><div>     insert into table student_ptn partition(age=18,department=&quot;A&quot;) select id,name where age = 18</div><div>     insert into table student_ptn partition(age=18,department=&quot;B&quot;) select id,name where age = 19;</div><div><br/></div><div>     // 验证多重分区的插入是否成功</div><div>     select id, name from student_ptn where age = 18 and department  = &quot;A&quot;;</div><div>     select id, name from student_ptn where age = 18 and department  = &quot;B&quot;;</div><div><br/></div><div>     // 动态分区</div><div>     set hive.exec.dynamic.partition = true;</div><div>     set hive.exec.dynamic.partition.mode = nonstrict;</div><div><br/></div><div>     drop table student_ptn;</div><div><br/></div><div>     insert into table student_ptn partition(age=101, department) select id, department, name from student;     XXXXXX</div><div>     insert into table student_ptn partition(age=202, department) select id, name, department from student;    √√√√√√√</div><div><br/></div><div>     insert into table student_ptn(age) select id, name, age from student;</div><div><br/></div><div>     动态分区的效果：</div><div><br/></div><div>     按照动态分区的字段的值做划分，一个值就是一个分区</div><div>     该studnet表当中的分区字段department有多少个值，就有多少个分区</div><div><br/></div><div>     每个分区就存一个分区字段值的所有数据</div><div><br/></div><div>     department = IS  CS   MA</div><div><br/></div><div>二、分桶</div><div>    </div><div>     概念：对分区的进一步的 更细粒度的划分。 分区类似</div><div><br/></div><div>     分桶的核心思想跟 MR程序的默认分区组件HashParititioner的原理一致</div><div>     原理：根据key的hash值去模除以reduceTask的个数/mapreduce的分区个数/hive表的分桶个数</div><div><br/></div><div>     分桶的原理：对分桶字段的值进行hash，然后模除以桶的个数，得到一个余数，该余数就是分桶的编号000000_0</div><div><br/></div><div>     MR     分区     mapper的outKey     reduceTask的个数</div><div>     hive     分桶     分桶字段的值     分桶的个数</div><div><br/></div><div>     分桶的效果：</div><div>     分桶字段的值经过分桶逻辑计算之后得到的余数相同的都在同一个分桶文件中</div><div><br/></div><div>     一个分桶文件可能存在分桶字段的多个值</div><div>     一个分桶文件也可能存在没有任何数据</div><div><br/></div><div>     AA BB CC DD EE</div><div>     分桶的个数：3</div><div>     AA=0</div><div>     BB=1</div><div>     CC=0</div><div>     DD=1</div><div>     EE=0</div><div>     上面的AA和CC和EE都会出现在第一个分桶文件当中</div><div>     上面的BB和DD都会出现在第二个分桶文件中</div><div>     第三个分桶文件当中就不会出现任何值。</div><div><br/></div><div>     表现形式上：</div><div>     如果没有分区，那么分桶的目录就是表目录的下一级</div><div>     如果有分区，那么分桶的目录在分区目录的下一级</div><div><br/></div><div>     分桶的操作：</div><div><br/></div><div>     创建分桶表：</div><div>     create table student_bucket (id int, name string, sex string, age int, department string) clustered by (age) sorted by(age desc, id asc) into 2 buckets row format delimited fields terminated by &quot;,&quot;;</div><div><br/></div><div>     往分桶表导入数据：</div><div>     load data local inpath &quot;/home/hadoop/student.txt&quot; into table student_bucket;</div><div>     注意：往分桶表导入数据，不能使用load方式   XXXXXXXXXXXX</div><div><br/></div><div>     insert .... values ....</div><div>     insert into table student_bucket values (101,&quot;liuyifei&quot;,&quot;female&quot;,22,&quot;NVSHEN&quot;);</div><div>     insert into table student_bucket values (102,&quot;luoyufeng&quot;,&quot;female&quot;,33,&quot;nvdiaosi&quot;);</div><div>     // insert ....values...     XXXXXXXXXXXX</div><div><br/></div><div>     // insert into .... select.....</div><div>     // XXXXXXXXXXXX</div><div>     insert into table student_bucket select id,name,sex,age,department from student;</div><div>    </div><div><br/></div><div>     √√√√√√√√√√√√√√√√√√√√√√√√</div><div>     //  使用注意：打开分桶的开关，设置对应的reduceTask的个数要跟桶数匹配</div><div>     set hive.enforce.bucketing = true;</div><div>     set mapred.reduce.tasks = 2; / set mapreduce.job.reduces = 2;</div><div>     insert into table student_bucket select id,name,sex,age,department from student distribute by age sort by age desc, id asc;</div><div>     √√√√√√√√√√√√√√√√√√√√√√√√</div><div><br/></div><div>    </div><div>     分桶的特例：</div><div>     create table student_bucket1 (id int, name string, sex string, age int, department string) clustered by (age) sorted by(age desc) into 2 buckets row format delimited fields terminated by &quot;,&quot;;</div><div><br/></div><div>     insert into table student_bucket1 select id,name,sex,age,department from student distribute by age;    XXXXXXXXXXXXX</div><div><br/></div><div>     验证的问题：最后分桶的数据到底有没有排序、</div><div><br/></div><div>     注意：创建分桶时指定的分桶和排序等等的信息都不能在数据插入的时候起作用</div><div>                数据到底有没有分桶是根据插入数据的HQL语句决定</div></span>
</div></body></html> 